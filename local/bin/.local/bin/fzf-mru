#!/bin/bash

FZF_SELECTED_FILES=/tmp/fzf_selected_files
FZF_MRU_FILES=/tmp/fzf_mru_files

cat ${FZF_SELECTED_FILES} >> ${FZF_MRU_FILES}
tac ${FZF_MRU_FILES} | awk '!seen[$0]++' | tac | sponge ${FZF_MRU_FILES}

# Get recent files from the current directory
tac ${FZF_MRU_FILES} | grep "^${PWD}/" | sed "s|^${PWD}/||" | head -5 > ${FZF_MRU_FILES}.tmp

cat ${FZF_MRU_FILES}.tmp <(eval "$FZF_DEFAULT_COMMAND" | grep -Fvxf ${FZF_MRU_FILES}.tmp) \
  | dimdirname \
  | devicon add \
  | fzf --ansi \
      --height=100% \
      --tiebreak=chunk \
      --header="$(tput setaf 1)ENTER$(tput sgr0) to open, $(tput setaf 1)CTRL-Y$(tput sgr0) to copy, $(tput setaf 1)CTRL-/$(tput sgr0) to toggle preview" \
      --preview="preview {}" \
      --preview-window=right,60%,border-sharp \
      --bind="enter:execute/echo $PWD/{} | devicon remove | xargs | tee ${FZF_SELECTED_FILES}/+abort" \
      --bind="tab:execute/echo $PWD/{} | devicon remove | xargs | tee ${FZF_SELECTED_FILES}/+abort" \
      --bind="ctrl-y:execute/echo {} | devicon remove | pbcopy/+abort"
