#!/bin/bash

list_pods="kubectl get pods"

copy_pod="echo {1} | pbcopy"
exec_pod="kubectl exec -it {1} -- bash"
edit_pod="kubectl edit pod/{1}"
logs_pod="kubectl logs {1} --tail=100 --prefix --all-containers --follow"
delete_pod="kubectl delete pod {1}"
describe_pod="kubectl describe pod {1}"

preview_pod="kubectl get pod {1} -o json | jq -r '.status.containerStatuses + .status.initContainerStatuses | sort_by(.name)[] | \"\(.name)\t\(.image | split(\":\")[-1])\t\(.ready)\t\(.state | keys_unsorted[0])\"'"
# TODO: add container name, image, ready, state to preview

red="$(tput setaf 1)"
reset="$(tput sgr0)"

header="\
${red}ENTER${reset} to exec, ${red}CTRL-O${reset} to open logs in vim, ${red}CTRL-E${reset} to edit, ${red}CTRL-D${reset} to describe, ${red}CTRL-K${reset} to delete, ${red}CTRL-Y${reset} to copy, ${red}CTRL-R${reset} to reload
"

eval "${list_pods}" | \
  fzf \
    --no-multi \
    --ansi \
    --prompt="$(kubectl config current-context)> " \
    --height=100% \
    --header="${header}" \
    --header-lines=1 \
    --preview="${preview_pod}" \
    --preview-window=right:60%:follow \
    --bind="enter:execute(echo ${exec_pod})+execute(${exec_pod})+reload-sync(${list_pods})" \
    --bind="ctrl-o:execute(echo ${logs_pod})+execute(${logs_pod})+reload-sync(${list_pods})" \
    --bind="ctrl-e:execute(echo ${edit_pod})+execute(${edit_pod})+reload-sync(${list_pods})" \
    --bind="ctrl-d:execute(echo ${describe_pod})+execute(${describe_pod} | less)+reload-sync(${list_pods})" \
    --bind="ctrl-k:execute(echo ${delete_pod})+execute(${delete_pod})+reload-sync(${list_pods})" \
    --bind="ctrl-y:execute-silent(${copy_pod})" \
    --bind="ctrl-r:reload-sync(${list_pods})"
