# Override tmux-sensible default-terminal value
set -g default-terminal xterm-kitty

# Fix slow new pane creation
# https://github.com/tmux/tmux/issues/1087#issuecomment-331949035
set -g default-command fish

# Hide tmux messages after 1s
set -g display-time 1000

# Fix fish_title doesn't work in tmux
set -g set-titles on
set -g set-titles-string '#T'

# Set vi mode for copy mode
set -g mode-keys vi

# Start window numbers at 1 to match keyboard order with tmux window order
set -g base-index 1
set -g pane-base-index 1

# Renumber windows sequentially after closing any of them
set -g renumber-windows on

# Don't suspend-client
unbind C-z

# Styles
set -g pane-border-style 'fg=#474e5d bg=#0c0c0c'
set -g pane-active-border-style 'fg=#474e5d bg=#0c0c0c'

set -g mode-style 'fg=#0c0c0c,bg=#28c9ff'

set -g status-justify left
set -g status-style bg=black,fg=white,none

set -g window-status-style bg=black,fg=colour240
set -g window-status-format '#[fg=yellow] #{window_index} #[default]#{window_name} '
set -g window-status-current-style fg=white,bg=colour235,bold
set -g window-status-current-format '#[fg=magenta] #{window_index} #[default]#{window_name} '

# OS specific settings
if-shell '[[ $(hostname) == *lima* ]]' {
  set -g status-position top
  set -g status-left ''

  # Local tmux keymappings
  # Tmux prefix: Option+Shift (Command is mapped to Option+Shift in Kitty)
  bind -T root M-T new-window
  bind -T root M-W kill-pane
  bind -T root M-N next-window
  bind -T root M-P previous-window
  bind -T root M-S split-window -v -p 25 -c '#{pane_current_path}'
  bind -T root M-R source ~/.tmux.conf \; display '~/.tmux.conf reloaded'

  bind -T root M-~ last-window
  bind -T root M-! select-window -t 1
  bind -T root M-@ select-window -t 2
  bind -T root M-# select-window -t 3
  bind -T root M-$ select-window -t 4
  bind -T root M-% select-window -t 5
  bind -T root M-^ select-window -t 6
  bind -T root M-& select-window -t 7
  bind -T root M-* select-window -t 8
  bind -T root M-( select-window -t 9
  bind -T root M-\{ swap-window -t -1 \; select-window -t -1
  bind -T root M-\} swap-window -t +1 \; select-window -t +1

  bind -T root M-_ resize-pane -D
  bind -T root M-+ resize-pane -U

  bind -T root M-: command-prompt
  bind -T root M-? copy-mode -eH

} {
  set -g status-position bottom

  set -g status-left ' ⧉ '
  set -g status-left-length 40

  # Fix ssh agent when tmux is detached
  set    -g update-environment -r
  setenv -g SSH_AUTH_SOCK $HOME/.ssh/ssh_auth_sock
  setenv -g SSH_TTY $HOME/.ssh/ssh_tty

  # Remote key mappings
  # Tmux prefix: Option
  bind -T root M-t new-window
  bind -T root M-w kill-pane
  bind -T root M-n next-window
  bind -T root M-p previous-window
  bind -T root M-s split-window -v -p 25 -c '#{pane_current_path}'
  bind -T root M-r source ~/.tmux.conf \; display '~/.tmux.conf reloaded'

  bind -T root M-` last-window
  bind -T root M-1 select-window -t 1
  bind -T root M-2 select-window -t 2
  bind -T root M-3 select-window -t 3
  bind -T root M-4 select-window -t 4
  bind -T root M-5 select-window -t 5
  bind -T root M-6 select-window -t 6
  bind -T root M-7 select-window -t 7
  bind -T root M-8 select-window -t 8
  bind -T root M-9 select-window -t 9
  bind -T root M-[ swap-window -t -1 \; select-window -t -1
  bind -T root M-] swap-window -t +1 \; select-window -t +1

  bind -T root M-- resize-pane -D
  bind -T root M-= resize-pane -U

  bind -T root M-\; command-prompt
}

# Replace the default prefix key binding
set -g prefix M-Space

# Fix osc52 copy to clipboard doesn't work in tmux
set -g set-clipboard on
set -g escape-time 100

# Fix Home/End key doesn't work in tmux
# https://stackoverflow.com/a/55616731
bind -T root Home send Escape OH
bind -T root End  send Escape OF

# `p` to jump between prompts
bind -T copy-mode-vi p send -X search-backward '^( |\[.+ .+\] )'

# Fix Ctrl+P doesn't work as expected in kubectl exec bash
# https://github.com/kubernetes/kubernetes/issues/71765
# https://stackoverflow.com/questions/59739696/kubectl-exec-bin-bash-eating-control-p
bind -T root C-p send Up

# Don't exit copy mode on double/triple click
bind -T copy-mode-vi DoubleClick1Pane select-pane \; send -X select-word
bind -T copy-mode-vi TripleClick1Pane select-pane \; send -X select-line

# `q` to exit copy mode & disable tmux mouse mouse
bind -T copy-mode-vi q copy-mode -q \; set mouse off

# Scroll one line at a time, and don't extend selection on mouse scroll
bind -T copy-mode-vi WheelUpPane   select-pane \; send -X -N 1 scroll-up
bind -T copy-mode-vi WheelDownPane select-pane \; send -X -N 1 scroll-down

# Turn on mouse mode for scrolling only, to preserve the existing Kitty's text
# selecting behavior.
# This also helps to avoid `^[[B` (arrow down ANSI code) from showing up when there's an
# unfinished command, and we scroll to bottom.
set  -g status-right '#(~/.local/bin/tmux-set-mouse-off.sh)'
set  -g status-interval 1
bind -T root         Up    if -Ft= '#{alternate_on}' 'send Up' "copy-mode -eH \; send Up \; set mouse on"
bind -T root         Down  if -Ft= '#{alternate_on}' 'send Down' "copy-mode -eH \; set mouse on"
bind -T copy-mode-vi Up    set mouse on \; select-pane \; send -X -N 1 scroll-up
bind -T copy-mode-vi Down  set mouse on \; select-pane \; send -X -N 1 scroll-down

# Hide position indicator when entering copy-mode when mouse mode is on
bind -T root WheelUpPane  if-shell -F "#{||:#{pane_in_mode},#{mouse_any_flag}}" { send-keys -M } { copy-mode -eH }

# Vim-style selection
bind -T copy-mode-vi C-v send -X begin-selection \; send -X rectangle-toggle
bind -T copy-mode-vi v   send -X begin-selection
bind -T copy-mode-vi V   send -X select-line

# Copy to system clipboard with `y`
bind -T copy-mode-vi y send -X copy-pipe pbcopy

# Enable incremental search in copy-mode-vi
bind -T copy-mode-vi / command-prompt -i -p 'search down' 'send -X search-forward-incremental "%%%"'
bind -T copy-mode-vi ? command-prompt -i -p 'search up' 'send -X search-backward-incremental "%%%"'

# Tmux plugins
run-shell ~/.tmux/plugins/sensible.tmux
