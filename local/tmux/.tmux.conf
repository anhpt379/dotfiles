# Override tmux-sensible default-terminal value
set -g default-terminal "xterm-kitty"

# Hide tmux messages after 1s
set -g display-time 1000

# Fix ssh agent when tmux is detached
set    -g update-environment -r
setenv -g SSH_AUTH_SOCK $HOME/.ssh/ssh_auth_sock
setenv -g SSH_TTY $HOME/.ssh/ssh_tty

# Fix fish_title doesn't work in tmux
set  -g set-titles on
set  -g set-titles-string '#T'

# Set vi mode for copy mode
setw -g mode-keys vi

# Start window numbers at 1 to match keyboard order with tmux window order
set  -g base-index 1
setw -g pane-base-index 1

# Renumber windows sequentially after closing any of them
set  -g renumber-windows on

# Remove administrative debris (session name, hostname, time) in status bar
set  -g status-left ''

# Don't suspend-client
unbind C-z

# Styles
set -g pane-border-style 'fg=#474e5d bg=#000000'
set -g pane-active-border-style 'fg=#474e5d bg=#000000'

set -g status-position bottom
set -g status-justify left

set -g status-left '#[fg=blue]⧉ '
set -g status-left-length 40
set -g status-right '#{prefix_highlight}'
set -g status-style bg=black,fg=white,none

set -g mode-style "fg=#000000,bg=#28c9ff"

setw -g window-status-style bg=black,fg=colour240
setw -g window-status-format '#[fg=yellow] #{window_index} #[default]#{window_name} '
setw -g window-status-current-style fg=white,bg=colour235,bold
setw -g window-status-current-format '#[fg=magenta] #{window_index} #[default]#{window_name} '

# Replace the default prefix key binding
set -g prefix M-Space

# Fix osc52 copy to clipboard doesn't work in tmux
set -g set-clipboard on
set -g escape-time 100

# Use Option key as tmux prefix
bind -n M-` last-window
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9
bind -n M-[ swap-window -t -1 \; select-window -t -1
bind -n M-] swap-window -t +1 \; select-window -t +1

bind -n M-s split-window -v -p 25 -c "#{pane_current_path}"
bind -n M-- resize-pane -D
bind -n M-= resize-pane -U

bind -n M-t new-window
bind -n M-w kill-window
bind -n M-n next-window
bind -n M-p previous-window
bind -n M-r source ~/.tmux.conf \; display "~/.tmux.conf reloaded"

bind -n M-/ copy-mode -e
bind -n M-\; command-prompt

bind -T copy-mode-vi p send -X search-backward '^( |\[.+ .+\] )'

# Fix Ctrl+P doesn't work as expected in kubectl exec bash
# https://github.com/kubernetes/kubernetes/issues/71765
# https://stackoverflow.com/questions/59739696/kubectl-exec-bin-bash-eating-control-p
bind -n C-p send Up

# Make terminal selection & tmux selection play nice with each other, by only
# turning on tmux mouse mode on scroll up
bind -n Up            if -Ft= '#{alternate_on}' "send Up" "copy-mode -e \; send Up \; set -w mouse on"
bind -n WheelDownPane select-pane \; set -w mouse off

# Don't exit copy mode on double/triple click
bind -T copy-mode-vi DoubleClick1Pane select-pane \; send -X select-word
bind -T copy-mode-vi TripleClick1Pane select-pane \; send -X select-line

# `q` to exit copy mode & disable tmux mouse mouse
bind -T copy-mode-vi q send -X cancel \; set -w mouse off

# Mouse single click to clear selection
bind -T copy-mode-vi MouseDown1Pane select-pane \; send -X clear-selection

# Don't exit copy mode on mouse selection
unbind -T copy-mode-vi MouseDragEnd1Pane

# Scroll one line at a time, and don't extend selection on mouse scroll
bind -T copy-mode-vi WheelDownPane select-pane \; send -X -N 1 scroll-down
bind -T copy-mode-vi WheelUpPane   select-pane \; send -X -N 1 scroll-up

# Vim-style selection
bind -T copy-mode-vi C-v send -X begin-selection \; send -X rectangle-toggle
bind -T copy-mode-vi v   send -X begin-selection
bind -T copy-mode-vi V   send -X select-line

# Copy to system clipboard with `y`
bind -T copy-mode-vi y send -X copy-pipe 'pbcopy'

# Enable incremental search in copy-mode-vi
bind -T copy-mode-vi / command-prompt -i -p "search down" "send -X search-forward-incremental \"%%%\""
bind -T copy-mode-vi ? command-prompt -i -p "search up" "send -X search-backward-incremental \"%%%\""

# Tmux plugins
run-shell ~/.tmux/plugins/sensible.tmux

set -g @prefix_highlight_show_copy_mode 'on'
set -g @prefix_highlight_copy_mode_attr 'fg=black,bg=yellow' # default is 'fg=default,bg=yellow'
set -g @prefix_highlight_copy_prompt    'COPY'
run-shell ~/.tmux/plugins/prefix_highlight.tmux
